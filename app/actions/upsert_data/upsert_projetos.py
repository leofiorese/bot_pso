import logging
import pandas as pd
from db.db import get_conn
from datetime import datetime
import os

TABLE_COLUMNS = [
    "PROJ_ID",
    "DEPT_ID",
    "TAXA_ID",
    "EMP_ID",
    "CLI_ID",
    "HE_ID_FAT",
    "HE_ID_PAG",
    "DT_INICIO",
    "DT_FIM",
    "DT_INICIO_INF",
    "DT_FIM_INF",
    "B_DT_INICIO",
    "B_DT_FIM",
    "CODIGO",
    "NOME",
    "DESCRICAO",
    "ATIVO",
    "USU_EMP_ID",
    "USU_CLI_ID",
    "PROJ_ID_PAI",
    "TIPO_DE_PROJETO",
    "CR_ID",
    "RGR_HORAS_TRANSPORTE",
    "RGR_HORAS_EXTRAS",
    "RGR_CRIAR_ATIVIDADES",
    "RGR_DELEGAR_ATIVIDADES",
    "RGR_APONTAR_ATIVIDADES",
    "RGR_INSTRUCOES_TRANSPORTE",
    "VALOR",
    "ALIQ_COFINS",
    "ALIQ_PIS",
    "ALIQ_ISS",
    "ALIQ_IRRF",
    "ALIQ_CSLL",
    "IND_IMPOSTOS_NA_TAXA_FAT",
    "COM_ID",
    "COM_ID_HIS",
    "INCLUIDO_EM",
    "ALTERADO_EM",
    "UDF1",
    "UDF2",
    "UDF3",
    "UDF4",
    "UDF5",
    "UDF6",
    "UDF7",
    "UDF8",
    "UDF9",
    "UDF10",
    "TRABALHO_PREVISTO",
    "TRABALHO_REALIZADO",
    "TRABALHO_FALTANDO",
    "TRABALHO_APONTADO",
    "DURACAO_PREVISTA",
    "B_TRABALHO_PREVISTO",
    "BCWP",
    "BCWS",
    "VA_VP",
    "CR_VC",
    "NUM_PROPOSTA",
    "TIPO_DI",
    "CLASSE",
    "PRIORIDADE_OS",
    "IND_HR_FAT_ATIV_OS",
    "WORKFLOW",
    "DEFPESQ_ID",
    "IND_HORAS_FATURAVEIS",
    "PROB_FECHAMENTO",
    "WKF_STEP",
    "WKF_STEP_DESC",
    "DT_ENCERRAMENTO",
    "IND_APO_BLOQ",
    "IND_FAT_BLOQ",
    "IND_PLAN_BLOQ",
    "LIMITE_MINUTOS",
    "VERSAO_CRONOGRAMA",
    "IND_OS_HABILITADO",
    "IND_CALCULO_MANUAL",
    "IND_DT_PREV_ATUALIZADA",
    "TRELLO_BOARD_ID",
    "TRELLO_LIST_ID_INICIO",
    "TRELLO_LIST_ID_FIM",
    "BILLIMATIC_CONTRATO",
    "BILLIMATIC_CONTRATO_ID",
    "IND_BILLIMATIC_PREV",
    "UDF11",
    "UDF12",
    "UDF13",
    "UDF14",
    "UDF15",
    "UDF16",
    "UDF17",
    "UDF18",
    "UDF19",
    "UDF20",
    "IND_BILLIMATIC_FAT_AUTOMATICO",
    "BILLIMATIC_MODELO_FAT_ID",
    "ENDERECO",
    "JIRA_PROJ_ID",
    "JIRA_RECURSO",
    "JIRA_DT_INICIO",
    "JIRA_ACCOUNT_ID",
    "JIRA_CRONOGRAMA",
    "AGILE_CONFIG",
    "AGILE_IND_APONTAMENTO",
    "AGILE_IND_PROJETO",
    "AGILE_PROJ_ID",
    "CFG_EPT_APONTAMENTO"
]

CREATE_TABLE_SQL = """
CREATE TABLE IF NOT EXISTS `PROJETOS` (
    `PROJ_ID` INT,
    `DEPT_ID` INT,
    `TAXA_ID` INT,
    `EMP_ID` INT,
    `CLI_ID` INT,
    `HE_ID_FAT` INT,
    `HE_ID_PAG` INT,
    `DT_INICIO` DATE,
    `DT_FIM` DATE,
    `DT_INICIO_INF` DATE,
    `DT_FIM_INF` DATE,
    `B_DT_INICIO` DATE,
    `B_DT_FIM` DATE,
    `CODIGO` VARCHAR(255),
    `NOME` VARCHAR(255),
    `DESCRICAO` TEXT,
    `ATIVO` VARCHAR(1),
    `USU_EMP_ID` INT,
    `USU_CLI_ID` INT,
    `PROJ_ID_PAI` INT,
    `TIPO_DE_PROJETO` VARCHAR(100),
    `CR_ID` INT,
    `RGR_HORAS_TRANSPORTE` DECIMAL(18,2),
    `RGR_HORAS_EXTRAS` DECIMAL(18,2),
    `RGR_CRIAR_ATIVIDADES` VARCHAR(1),
    `RGR_DELEGAR_ATIVIDADES` VARCHAR(1),
    `RGR_APONTAR_ATIVIDADES` VARCHAR(1),
    `RGR_INSTRUCOES_TRANSPORTE` TEXT,
    `VALOR` DECIMAL(18,2),
    `ALIQ_COFINS` DECIMAL(10,2),
    `ALIQ_PIS` DECIMAL(10,2),
    `ALIQ_ISS` DECIMAL(10,2),
    `ALIQ_IRRF` DECIMAL(10,2),
    `ALIQ_CSLL` DECIMAL(10,2),
    `IND_IMPOSTOS_NA_TAXA_FAT` VARCHAR(1),
    `COM_ID` INT,
    `COM_ID_HIS` INT,
    `INCLUIDO_EM` DATE,
    `ALTERADO_EM` DATE,
    `UDF1` VARCHAR(255),
    `UDF2` VARCHAR(255),
    `UDF3` VARCHAR(255),
    `UDF4` VARCHAR(255),
    `UDF5` VARCHAR(255),
    `UDF6` VARCHAR(255),
    `UDF7` VARCHAR(255),
    `UDF8` VARCHAR(255),
    `UDF9` VARCHAR(255),
    `UDF10` VARCHAR(255),
    `TRABALHO_PREVISTO` DECIMAL(18,2),
    `TRABALHO_REALIZADO` DECIMAL(18,2),
    `TRABALHO_FALTANDO` DECIMAL(18,2),
    `TRABALHO_APONTADO` DECIMAL(18,2),
    `DURACAO_PREVISTA` DECIMAL(18,2),
    `B_TRABALHO_PREVISTO` DECIMAL(18,2),
    `BCWP` DECIMAL(18,2),
    `BCWS` DECIMAL(18,2),
    `VA_VP` DECIMAL(18,2),
    `CR_VC` DECIMAL(18,2),
    `NUM_PROPOSTA` VARCHAR(100),
    `TIPO_DI` VARCHAR(100),
    `CLASSE` VARCHAR(100),
    `PRIORIDADE_OS` VARCHAR(100),
    `IND_HR_FAT_ATIV_OS` VARCHAR(1),
    `WORKFLOW` VARCHAR(255),
    `DEFPESQ_ID` INT,
    `IND_HORAS_FATURAVEIS` VARCHAR(1),
    `PROB_FECHAMENTO` DECIMAL(10,2),
    `WKF_STEP` INT,
    `WKF_STEP_DESC` VARCHAR(255),
    `DT_ENCERRAMENTO` DATE,
    `IND_APO_BLOQ` VARCHAR(1),
    `IND_FAT_BLOQ` VARCHAR(1),
    `IND_PLAN_BLOQ` VARCHAR(1),
    `LIMITE_MINUTOS` INT,
    `VERSAO_CRONOGRAMA` INT,
    `IND_OS_HABILITADO` VARCHAR(1),
    `IND_CALCULO_MANUAL` VARCHAR(1),
    `IND_DT_PREV_ATUALIZADA` VARCHAR(1),
    `TRELLO_BOARD_ID` VARCHAR(255),
    `TRELLO_LIST_ID_INICIO` VARCHAR(255),
    `TRELLO_LIST_ID_FIM` VARCHAR(255),
    `BILLIMATIC_CONTRATO` VARCHAR(1),
    `BILLIMATIC_CONTRATO_ID` INT,
    `IND_BILLIMATIC_PREV` VARCHAR(1),
    `UDF11` VARCHAR(255),
    `UDF12` VARCHAR(255),
    `UDF13` VARCHAR(255),
    `UDF14` VARCHAR(255),
    `UDF15` VARCHAR(255),
    `UDF16` VARCHAR(255),
    `UDF17` VARCHAR(255),
    `UDF18` VARCHAR(255),
    `UDF19` VARCHAR(255),
    `UDF20` VARCHAR(255),
    `IND_BILLIMATIC_FAT_AUTOMATICO` VARCHAR(1),
    `BILLIMATIC_MODELO_FAT_ID` INT,
    `ENDERECO` VARCHAR(255),
    `JIRA_PROJ_ID` BIGINT,
    `JIRA_RECURSO` VARCHAR(255),
    `JIRA_DT_INICIO` DATE,
    `JIRA_ACCOUNT_ID` VARCHAR(255),
    `JIRA_CRONOGRAMA` VARCHAR(255),
    `AGILE_CONFIG` VARCHAR(255),
    `AGILE_IND_APONTAMENTO` VARCHAR(1),
    `AGILE_IND_PROJETO` VARCHAR(1),
    `AGILE_PROJ_ID` BIGINT,
    `CFG_EPT_APONTAMENTO` VARCHAR(5),

    `created_at` TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    `updated_at` TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,

    PRIMARY KEY (`PROJ_ID`)
)
ENGINE=InnoDB
DEFAULT CHARSET=utf8mb4
COLLATE=utf8mb4_unicode_ci;
"""

UPSERT_SQL = """
INSERT INTO PROJETOS (
    PROJ_ID, DEPT_ID, TAXA_ID, EMP_ID, CLI_ID, HE_ID_FAT, HE_ID_PAG, DT_INICIO, DT_FIM, DT_INICIO_INF, DT_FIM_INF, B_DT_INICIO, B_DT_FIM,
    CODIGO, NOME, DESCRICAO, ATIVO, USU_EMP_ID, USU_CLI_ID, PROJ_ID_PAI, TIPO_DE_PROJETO, CR_ID, RGR_HORAS_TRANSPORTE, RGR_HORAS_EXTRAS,
    RGR_CRIAR_ATIVIDADES, RGR_DELEGAR_ATIVIDADES, RGR_APONTAR_ATIVIDADES, RGR_INSTRUCOES_TRANSPORTE, VALOR, ALIQ_COFINS, ALIQ_PIS, ALIQ_ISS,
    ALIQ_IRRF, ALIQ_CSLL, IND_IMPOSTOS_NA_TAXA_FAT, COM_ID, COM_ID_HIS, INCLUIDO_EM, ALTERADO_EM, UDF1, UDF2, UDF3, UDF4, UDF5, UDF6, UDF7,
    UDF8, UDF9, UDF10, TRABALHO_PREVISTO, TRABALHO_REALIZADO, TRABALHO_FALTANDO, TRABALHO_APONTADO, DURACAO_PREVISTA, B_TRABALHO_PREVISTO,
    BCWP, BCWS, VA_VP, CR_VC, NUM_PROPOSTA, TIPO_DI, CLASSE, PRIORIDADE_OS, IND_HR_FAT_ATIV_OS, WORKFLOW, DEFPESQ_ID, IND_HORAS_FATURAVEIS,
    PROB_FECHAMENTO, WKF_STEP, WKF_STEP_DESC, DT_ENCERRAMENTO, IND_APO_BLOQ, IND_FAT_BLOQ, IND_PLAN_BLOQ, LIMITE_MINUTOS, VERSAO_CRONOGRAMA,
    IND_OS_HABILITADO, IND_CALCULO_MANUAL, IND_DT_PREV_ATUALIZADA, TRELLO_BOARD_ID, TRELLO_LIST_ID_INICIO, TRELLO_LIST_ID_FIM, BILLIMATIC_CONTRATO,
    BILLIMATIC_CONTRATO_ID, IND_BILLIMATIC_PREV, UDF11, UDF12, UDF13, UDF14, UDF15, UDF16, UDF17, UDF18, UDF19, UDF20, IND_BILLIMATIC_FAT_AUTOMATICO,
    BILLIMATIC_MODELO_FAT_ID, ENDERECO, JIRA_PROJ_ID, JIRA_RECURSO, JIRA_DT_INICIO, JIRA_ACCOUNT_ID, JIRA_CRONOGRAMA, AGILE_CONFIG, AGILE_IND_APONTAMENTO,
    AGILE_IND_PROJETO, AGILE_PROJ_ID, CFG_EPT_APONTAMENTO
) VALUES (
    %(PROJ_ID)s, %(DEPT_ID)s, %(TAXA_ID)s, %(EMP_ID)s, %(CLI_ID)s, %(HE_ID_FAT)s, %(HE_ID_PAG)s, %(DT_INICIO)s, %(DT_FIM)s, %(DT_INICIO_INF)s, %(DT_FIM_INF)s, %(B_DT_INICIO)s, %(B_DT_FIM)s,
    %(CODIGO)s, %(NOME)s, %(DESCRICAO)s, %(ATIVO)s, %(USU_EMP_ID)s, %(USU_CLI_ID)s, %(PROJ_ID_PAI)s, %(TIPO_DE_PROJETO)s, %(CR_ID)s, %(RGR_HORAS_TRANSPORTE)s, %(RGR_HORAS_EXTRAS)s,
    %(RGR_CRIAR_ATIVIDADES)s, %(RGR_DELEGAR_ATIVIDADES)s, %(RGR_APONTAR_ATIVIDADES)s, %(RGR_INSTRUCOES_TRANSPORTE)s, %(VALOR)s, %(ALIQ_COFINS)s, %(ALIQ_PIS)s, %(ALIQ_ISS)s,
    %(ALIQ_IRRF)s, %(ALIQ_CSLL)s, %(IND_IMPOSTOS_NA_TAXA_FAT)s, %(COM_ID)s, %(COM_ID_HIS)s, %(INCLUIDO_EM)s, %(ALTERADO_EM)s, %(UDF1)s, %(UDF2)s, %(UDF3)s, %(UDF4)s, %(UDF5)s, %(UDF6)s, %(UDF7)s,
    %(UDF8)s, %(UDF9)s, %(UDF10)s, %(TRABALHO_PREVISTO)s, %(TRABALHO_REALIZADO)s, %(TRABALHO_FALTANDO)s, %(TRABALHO_APONTADO)s, %(DURACAO_PREVISTA)s, %(B_TRABALHO_PREVISTO)s,
    %(BCWP)s, %(BCWS)s, %(VA_VP)s, %(CR_VC)s, %(NUM_PROPOSTA)s, %(TIPO_DI)s, %(CLASSE)s, %(PRIORIDADE_OS)s, %(IND_HR_FAT_ATIV_OS)s, %(WORKFLOW)s, %(DEFPESQ_ID)s, %(IND_HORAS_FATURAVEIS)s,
    %(PROB_FECHAMENTO)s, %(WKF_STEP)s, %(WKF_STEP_DESC)s, %(DT_ENCERRAMENTO)s, %(IND_APO_BLOQ)s, %(IND_FAT_BLOQ)s, %(IND_PLAN_BLOQ)s, %(LIMITE_MINUTOS)s, %(VERSAO_CRONOGRAMA)s,
    %(IND_OS_HABILITADO)s, %(IND_CALCULO_MANUAL)s, %(IND_DT_PREV_ATUALIZADA)s, %(TRELLO_BOARD_ID)s, %(TRELLO_LIST_ID_INICIO)s, %(TRELLO_LIST_ID_FIM)s, %(BILLIMATIC_CONTRATO)s,
    %(BILLIMATIC_CONTRATO_ID)s, %(IND_BILLIMATIC_PREV)s, %(UDF11)s, %(UDF12)s, %(UDF13)s, %(UDF14)s, %(UDF15)s, %(UDF16)s, %(UDF17)s, %(UDF18)s, %(UDF19)s, %(UDF20)s, %(IND_BILLIMATIC_FAT_AUTOMATICO)s,
    %(BILLIMATIC_MODELO_FAT_ID)s, %(ENDERECO)s, %(JIRA_PROJ_ID)s, %(JIRA_RECURSO)s, %(JIRA_DT_INICIO)s, %(JIRA_ACCOUNT_ID)s, %(JIRA_CRONOGRAMA)s, %(AGILE_CONFIG)s, %(AGILE_IND_APONTAMENTO)s,
    %(AGILE_IND_PROJETO)s, %(AGILE_PROJ_ID)s, %(CFG_EPT_APONTAMENTO)s
)
ON DUPLICATE KEY UPDATE
    DEPT_ID = VALUES(DEPT_ID),
    TAXA_ID = VALUES(TAXA_ID),
    EMP_ID = VALUES(EMP_ID),
    CLI_ID = VALUES(CLI_ID),
    HE_ID_FAT = VALUES(HE_ID_FAT),
    HE_ID_PAG = VALUES(HE_ID_PAG),
    DT_INICIO = VALUES(DT_INICIO),
    DT_FIM = VALUES(DT_FIM),
    DT_INICIO_INF = VALUES(DT_INICIO_INF),
    DT_FIM_INF = VALUES(DT_FIM_INF),
    B_DT_INICIO = VALUES(B_DT_INICIO),
    B_DT_FIM = VALUES(B_DT_FIM),
    CODIGO = VALUES(CODIGO),
    NOME = VALUES(NOME),
    DESCRICAO = VALUES(DESCRICAO),
    ATIVO = VALUES(ATIVO),
    USU_EMP_ID = VALUES(USU_EMP_ID),
    USU_CLI_ID = VALUES(USU_CLI_ID),
    PROJ_ID_PAI = VALUES(PROJ_ID_PAI),
    TIPO_DE_PROJETO = VALUES(TIPO_DE_PROJETO),
    CR_ID = VALUES(CR_ID),
    RGR_HORAS_TRANSPORTE = VALUES(RGR_HORAS_TRANSPORTE),
    RGR_HORAS_EXTRAS = VALUES(RGR_HORAS_EXTRAS),
    RGR_CRIAR_ATIVIDADES = VALUES(RGR_CRIAR_ATIVIDADES),
    RGR_DELEGAR_ATIVIDADES = VALUES(RGR_DELEGAR_ATIVIDADES),
    RGR_APONTAR_ATIVIDADES = VALUES(RGR_APONTAR_ATIVIDADES),
    RGR_INSTRUCOES_TRANSPORTE = VALUES(RGR_INSTRUCOES_TRANSPORTE),
    VALOR = VALUES(VALOR),
    ALIQ_COFINS = VALUES(ALIQ_COFINS),
    ALIQ_PIS = VALUES(ALIQ_PIS),
    ALIQ_ISS = VALUES(ALIQ_ISS),
    ALIQ_IRRF = VALUES(ALIQ_IRRF),
    ALIQ_CSLL = VALUES(ALIQ_CSLL),
    IND_IMPOSTOS_NA_TAXA_FAT = VALUES(IND_IMPOSTOS_NA_TAXA_FAT),
    COM_ID = VALUES(COM_ID),
    COM_ID_HIS = VALUES(COM_ID_HIS),
    INCLUIDO_EM = VALUES(INCLUIDO_EM),
    ALTERADO_EM = VALUES(ALTERADO_EM),
    UDF1 = VALUES(UDF1),
    UDF2 = VALUES(UDF2),
    UDF3 = VALUES(UDF3),
    UDF4 = VALUES(UDF4),
    UDF5 = VALUES(UDF5),
    UDF6 = VALUES(UDF6),
    UDF7 = VALUES(UDF7),
    UDF8 = VALUES(UDF8),
    UDF9 = VALUES(UDF9),
    UDF10 = VALUES(UDF10),
    TRABALHO_PREVISTO = VALUES(TRABALHO_PREVISTO),
    TRABALHO_REALIZADO = VALUES(TRABALHO_REALIZADO),
    TRABALHO_FALTANDO = VALUES(TRABALHO_FALTANDO),
    TRABALHO_APONTADO = VALUES(TRABALHO_APONTADO),
    DURACAO_PREVISTA = VALUES(DURACAO_PREVISTA),
    B_TRABALHO_PREVISTO = VALUES(B_TRABALHO_PREVISTO),
    BCWP = VALUES(BCWP),
    BCWS = VALUES(BCWS),
    VA_VP = VALUES(VA_VP),
    CR_VC = VALUES(CR_VC),
    NUM_PROPOSTA = VALUES(NUM_PROPOSTA),
    TIPO_DI = VALUES(TIPO_DI),
    CLASSE = VALUES(CLASSE),
    PRIORIDADE_OS = VALUES(PRIORIDADE_OS),
    IND_HR_FAT_ATIV_OS = VALUES(IND_HR_FAT_ATIV_OS),
    WORKFLOW = VALUES(WORKFLOW),
    DEFPESQ_ID = VALUES(DEFPESQ_ID),
    IND_HORAS_FATURAVEIS = VALUES(IND_HORAS_FATURAVEIS),
    PROB_FECHAMENTO = VALUES(PROB_FECHAMENTO),
    WKF_STEP = VALUES(WKF_STEP),
    WKF_STEP_DESC = VALUES(WKF_STEP_DESC),
    DT_ENCERRAMENTO = VALUES(DT_ENCERRAMENTO),
    IND_APO_BLOQ = VALUES(IND_APO_BLOQ),
    IND_FAT_BLOQ = VALUES(IND_FAT_BLOQ),
    IND_PLAN_BLOQ = VALUES(IND_PLAN_BLOQ),
    LIMITE_MINUTOS = VALUES(LIMITE_MINUTOS),
    VERSAO_CRONOGRAMA = VALUES(VERSAO_CRONOGRAMA),
    IND_OS_HABILITADO = VALUES(IND_OS_HABILITADO),
    IND_CALCULO_MANUAL = VALUES(IND_CALCULO_MANUAL),
    IND_DT_PREV_ATUALIZADA = VALUES(IND_DT_PREV_ATUALIZADA),
    TRELLO_BOARD_ID = VALUES(TRELLO_BOARD_ID),
    TRELLO_LIST_ID_INICIO = VALUES(TRELLO_LIST_ID_INICIO),
    TRELLO_LIST_ID_FIM = VALUES(TRELLO_LIST_ID_FIM),
    BILLIMATIC_CONTRATO = VALUES(BILLIMATIC_CONTRATO),
    BILLIMATIC_CONTRATO_ID = VALUES(BILLIMATIC_CONTRATO_ID),
    IND_BILLIMATIC_PREV = VALUES(IND_BILLIMATIC_PREV),
    UDF11 = VALUES(UDF11),
    UDF12 = VALUES(UDF12),
    UDF13 = VALUES(UDF13),
    UDF14 = VALUES(UDF14),
    UDF15 = VALUES(UDF15),
    UDF16 = VALUES(UDF16),
    UDF17 = VALUES(UDF17),
    UDF18 = VALUES(UDF18),
    UDF19 = VALUES(UDF19),
    UDF20 = VALUES(UDF20),
    IND_BILLIMATIC_FAT_AUTOMATICO = VALUES(IND_BILLIMATIC_FAT_AUTOMATICO),
    BILLIMATIC_MODELO_FAT_ID = VALUES(BILLIMATIC_MODELO_FAT_ID),
    ENDERECO = VALUES(ENDERECO),
    JIRA_PROJ_ID = VALUES(JIRA_PROJ_ID),
    JIRA_RECURSO = VALUES(JIRA_RECURSO),
    JIRA_DT_INICIO = VALUES(JIRA_DT_INICIO),
    JIRA_ACCOUNT_ID = VALUES(JIRA_ACCOUNT_ID),
    JIRA_CRONOGRAMA = VALUES(JIRA_CRONOGRAMA),
    AGILE_CONFIG = VALUES(AGILE_CONFIG),
    AGILE_IND_APONTAMENTO = VALUES(AGILE_IND_APONTAMENTO),
    AGILE_IND_PROJETO = VALUES(AGILE_IND_PROJETO),
    AGILE_PROJ_ID = VALUES(AGILE_PROJ_ID),
    CFG_EPT_APONTAMENTO = VALUES(CFG_EPT_APONTAMENTO);
"""

def create_table(cursor, table_name):
    try:
        cursor.execute(CREATE_TABLE_SQL)
        logging.info(f"Tabela {table_name} criada/verificada.")
    except Exception as e:
        logging.error(f"Erro ao criar/verificar a tabela: {e}")
        raise

def convert_date(value):
    if isinstance(value, str):
        try:
            return datetime.strptime(value, '%d/%m/%Y').strftime('%Y-%m-%d')
        except ValueError:
            return None  
    return value

def clean_data(value, column_name):
    if column_name in [
        "DT_INICIO","DT_FIM","DT_INICIO_INF","DT_FIM_INF","B_DT_INICIO","B_DT_FIM",
        "INCLUIDO_EM","ALTERADO_EM","DT_ENCERRAMENTO","JIRA_DT_INICIO"
    ]:
        return convert_date(value)
    if pd.isna(value) or value == "" or value is None or pd.isnull(value):
        return None
    return value

def upsert_data(df: pd.DataFrame, table_name: str, csv_file_path: str):
    conn = None
    cursor = None
    try:
        conn = get_conn()
        cursor = conn.cursor()
        create_table(cursor, table_name)
        for col in df.columns:
            df[col] = df[col].apply(lambda x: clean_data(x, col))
        for _, row in df.iterrows():
            data_tuple = row.to_dict()
            for key, value in data_tuple.items():
                if isinstance(value, float) and pd.isna(value):
                    data_tuple[key] = None 
            cursor.execute(UPSERT_SQL, data_tuple)
        conn.commit()
        if os.path.exists(csv_file_path):
            os.remove(csv_file_path)
    except Exception as e:
        if conn:
            conn.rollback()
        raise
    finally:
        if cursor:
            cursor.close()
        if conn:
            conn.close()
